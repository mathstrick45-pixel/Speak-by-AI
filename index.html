<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Speak Practice ‚Äî AI Teacher</title>
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="/manifest.json" />
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#2563eb;--muted:#6b7280}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111}
    .wrap{max-width:820px;margin:18px auto;padding:18px}
    .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.06)}
    h1{margin:0 0 6px} .sub{color:var(--muted);margin:0 0 12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .primary{background:var(--accent);color:#fff} .danger{background:#fee2e2;color:#891b1b}
    .ghost{background:#eef2ff;color:#1e3a8a}
    textarea{width:100%;min-height:110px;padding:12px;border-radius:10px;border:1px solid #eef2f6;font-size:16px}
    .out{margin-top:12px;background:#f8fafc;padding:12px;border-radius:10px;border:1px solid #eef2f6}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;margin-right:8px}
    .issue{background:#fff6f6;border-left:4px solid #fca5a5;padding:10px;border-radius:6px;margin-top:8px}
    .good{background:#f0fdf4;border-left:4px solid #a7f3d0;padding:10px;border-radius:6px;margin-top:8px}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Speak Practice ‚Äî AI Teacher</h1>
      <p class="sub">Speak in English, get corrected sentence + explanation from the AI teacher.</p>

      <div class="controls">
        <button id="startBtn" class="primary">üéôÔ∏è Start Speaking</button>
        <button id="stopBtn" class="danger">‚èπ Stop</button>
        <button id="playBtn" class="ghost">üîä Play Corrected</button>
        <button id="evaluateBtn" class="primary">‚úÖ Ask Teacher</button>
      </div>

      <label class="small">Transcript / Type here:</label>
      <textarea id="text" placeholder="Speak or type a sentence..."></textarea>

      <div class="out" id="status">Status: idle</div>

      <h3 style="margin-top:10px">Teacher feedback</h3>
      <div id="result" class="out">
        <div id="loading" style="display:none">Working‚Ä¶</div>
        <div id="correction"></div>
        <div id="explanation" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:12px" class="small">
        Tip: Use Chrome on Android for best speech-recognition results. <br>
        This app uses a serverless function to call OpenAI ‚Äî set your API key in Vercel as <code>OPENAI_API_KEY</code>.
      </div>
    </div>
  </div>

<script>
/* -------------------------
   Speech Recognition (client)
   ------------------------- */
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const evaluateBtn = document.getElementById('evaluateBtn');
const textEl = document.getElementById('text');
const statusEl = document.getElementById('status');
const correctionEl = document.getElementById('correction');
const explanationEl = document.getElementById('explanation');
const loadingEl = document.getElementById('loading');

let recognition = null;
function initSR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) {
    alert('Speech Recognition not supported in this browser. Use Chrome on Android.');
    return null;
  }
  const r = new SR();
  r.lang = 'en-US';
  r.interimResults = true;
  r.continuous = true;
  r.onresult = (ev) => {
    let interim = '';
    let final = '';
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      const res = ev.results[i];
      if(res.isFinal) final += res[0].transcript + ' ';
      else interim += res[0].transcript + ' ';
    }
    // append final & interim sensibly:
    if(final) textEl.value = (textEl.value.trim() + ' ' + final).trim();
    else if(interim) textEl.value = (textEl.value.trim() + ' ' + interim).trim();
  };
  r.onstart = ()=> statusEl.textContent = 'Status: listening...';
  r.onend = ()=> statusEl.textContent = 'Status: idle';
  r.onerror = (e)=> console.error('sr err', e);
  return r;
}

startBtn.onclick = ()=>{
  if(!recognition) recognition = initSR();
  if(!recognition) return;
  recognition.start();
};
stopBtn.onclick = ()=> recognition && recognition.stop();

/* -------------------------
   Ask teacher (server)
   ------------------------- */
async function askTeacher(sentence){
  if(!sentence || !sentence.trim()) return;
  loadingEl.style.display = 'block';
  correctionEl.innerHTML = '';
  explanationEl.innerHTML = '';
  try {
    const resp = await fetch('/api/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: sentence })
    });
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error(txt || 'Server error');
    }
    const data = await resp.json();
    // expected: { corrected: "...", explanation: "..." }
    correctionEl.innerHTML = data.corrected ? `<strong>Corrected:</strong> <div style="margin-top:6px">${escapeHtml(data.corrected)}</div>` : '';
    explanationEl.innerHTML = data.explanation ? `<strong>Teacher notes:</strong><div style="margin-top:6px">${escapeHtml(data.explanation).replace(/\n/g,'<br>')}</div>` : '';
  } catch(err){
    correctionEl.innerHTML = `<div class="issue">Error: ${escapeHtml(err.message || String(err))}</div>`;
  } finally {
    loadingEl.style.display = 'none';
  }
}
evaluateBtn.onclick = ()=> askTeacher(textEl.value);

/* Play corrected with TTS */
playBtn.onclick = ()=> {
  const content = correctionEl.textContent || correctionEl.innerText;
  if(!content) return;
  const utter = new SpeechSynthesisUtterance(content.replace(/^Corrected:\s*/i,''));
  utter.lang = 'en-US';
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
};

/* small helper */
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* Auto-evaluate on speech end */
if('SpeechRecognition' in window || 'webkitSpeechRecognition' in window){
  // attach onend to auto-evaluate if desired (kept manual in this final)
}
</script>
</body>
</html>        <button id="stopBtn" class="btn danger">‚èπ Stop</button>
        <button id="speakCorrectBtn" class="btn ok">üîä Play Corrected</button>
        <button id="clearBtn" class="btn ghost">üßπ Clear</button>
      </div>

      <p class="hint" style="margin-top:8px">
        Tip: Android Chrome ‡§Æ‡•á‡§Ç best results. iOS Safari ‡§Æ‡•á‡§Ç STT ‡§ï‡§≠‡•Ä-‡§ï‡§≠‡•Ä limited ‡§π‡•ã‡§§‡§æ ‡§π‡•à.
      </p>

      <h3>Transcript / Type here</h3>
      <textarea id="input" placeholder="Speak and it will appear here‚Ä¶ Or type your sentence to evaluate."></textarea>

      <div class="row" style="margin-top:10px">
        <button id="evaluateBtn" class="btn primary">‚úÖ Evaluate</button>
        <label class="pill"><input type="checkbox" id="autoEval" checked /> Auto-evaluate on stop</label>
      </div>

      <h3 style="margin-top:18px">Feedback</h3>
      <div id="feedback"></div>

      <h3 style="margin-top:18px">Corrected Sentence</h3>
      <div id="corrected" class="out"></div>

      <div class="footer">PWA: offline once opened ‚Ä¢ No data leaves your device</div>
    </div>
  </div>

  <script>
    /*********************
     * SPEECH RECOGNITION
     *********************/
    const recBtn = document.getElementById('recBtn');
    const stopBtn = document.getElementById('stopBtn');
    const input = document.getElementById('input');
    const autoEval = document.getElementById('autoEval');
    let recognition = null, listening = false;

    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert('Speech Recognition not supported in this browser. Try Chrome on Android.'); return null; }
      const r = new SR();
      r.lang = 'en-US';
      r.interimResults = true;
      r.continuous = true;
      r.onresult = (e)=>{
        let finalText = '';
        for(let i=e.resultIndex; i<e.results.length; i++){
          finalText += e.results[i][0].transcript;
        }
        input.value = input.value.replace(/\s+$/,'') + (finalText ? ' ' + finalText : '');
      };
      r.onend = ()=>{
        listening = false;
        recBtn.textContent = 'üéôÔ∏è Start Speaking';
        if(autoEval.checked) evaluate();
      };
      r.onerror = (e)=> console.warn('STT error', e.error);
      return r;
    }

    recBtn.onclick = ()=>{
      if(listening){ recognition && recognition.stop(); return; }
      if(!recognition) recognition = initSTT();
      if(!recognition) return;
      input.value = input.value.trim();
      recognition.start(); listening = true;
      recBtn.textContent = 'üéôÔ∏è Listening‚Ä¶';
    };
    stopBtn.onclick = ()=> recognition && recognition.stop();

    /*********************
     * TTS (Play corrected)
     *********************/
    document.getElementById('speakCorrectBtn').onclick = ()=>{
      const text = document.getElementById('corrected').textContent.trim();
      if(!text) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    };

    document.getElementById('clearBtn').onclick = ()=>{
      input.value = ''; document.getElementById('feedback').innerHTML = '';
      document.getElementById('corrected').innerHTML = '';
    };

    /******************************
     * LIGHTWEIGHT ‚ÄúAI TEACHER‚Äù
     * (Rule-based grammar fixer)
     ******************************/
    const VERB_S = {go:'goes', do:'does', have:'has', eat:'eats', like:'likes', play:'plays', say:'says', want:'wants', need:'needs', make:'makes', take:'takes', come:'comes', read:'reads', watch:'watches', study:'studies'};
    const BE_FOR_SUBJ = {'i':'am','you':'are','we':'are','they':'are','he':'is','she':'is','it':'is'};

    function capitalizeSent(s){ return s.replace(/(^\s*[a-z])/, m=>m.toUpperCase()); }
    function endWithPeriod(s){ return /[.!?]\s*$/.test(s)? s : s.trim()+'.'; }

    function fixArticles(tokens, notes){
      for(let i=0;i<tokens.length-1;i++){
        const w = tokens[i].toLowerCase(), nxt = tokens[i+1]?.toLowerCase() || '';
        if((w==='a'||w==='an') && /^[aeiou]/.test(nxt)){
          if(w==='a'){ tokens[i]='an'; notes.push(['article',`Use ‚Äúan‚Äù before vowel sound: "${nxt}"`]); }
        } else if((w==='a'||w==='an') && !/^[aeiou]/.test(nxt)){
          if(w==='an'){ tokens[i]='a'; notes.push(['article',`Use ‚Äúa‚Äù before consonant sound: "${nxt}"`]); }
        }
      }
    }

    function fixHeSheVerb(tokens, notes){
      // pattern: he/she/it + base verb -> add -s (for common verbs)
      for(let i=0;i<tokens.length-1;i++){
        const s = tokens[i].toLowerCase(), v = tokens[i+1].toLowerCase();
        if(['he','she','it'].includes(s)){
          if(VERB_S[v]){ tokens[i+1] = VERB_S[v]; notes.push(['verb',`With "${tokens[i]}", use "${VERB_S[v]}" not "${v}".`]); }
          else if(/^[a-z]+$/.test(v) && !/(s|sh|ch|x|z|o|ies)$/.test(v)){
            tokens[i+1] = v+'s'; notes.push(['verb',`With "${tokens[i]}", add -s: ‚Äú${v}s‚Äù.`]);
          }
        }
      }
    }

    function fixBeVerb(tokens, notes){
      // e.g., I good -> I am good; He happy -> He is happy
      for(let i=0;i<tokens.length-1;i++){
        const s = tokens[i].toLowerCase(), nxt = tokens[i+1].toLowerCase();
        if(BE_FOR_SUBJ[s] && !['am','is','are','was','were'].includes(nxt) && /^[a-z]+$/.test(nxt)){
          tokens.splice(i+1,0,BE_FOR_SUBJ[s]);
          notes.push(['be-verb',`Add ‚Äú${BE_FOR_SUBJ[s]}‚Äù after ‚Äú${tokens[i]}‚Äù.`]);
          i++;
        }
      }
    }

    function fixIcap(tokens, notes){
      for(let i=0;i<tokens.length;i++){
        if(tokens[i]==='i'){ tokens[i]='I'; notes.push(['capitalization','Capitalize ‚ÄúI‚Äù.']); }
      }
    }

    function fixAint(tokens, notes){
      // don't have no -> don't have any
      for(let i=0;i<tokens.length-1;i++){
        if(tokens[i].toLowerCase()==='no' && i>0 && /(don't|didn't|doesn't|can't|won't)/i.test(tokens[i-1])){
          tokens[i]='any'; notes.push(['negation','Use ‚Äúany‚Äù with negatives (not ‚Äúno‚Äù).']);
        }
      }
    }

    function pluralAfterNumber(tokens, notes){
      for(let i=0;i<tokens.length-1;i++){
        if(/^\d+$/.test(tokens[i]) && /^[a-z]+$/.test(tokens[i+1]) && !/s$/.test(tokens[i+1])){
          tokens[i+1] = tokens[i+1]+'s';
          notes.push(['plural',`After numbers, use plural: ‚Äú${tokens[i+1]}‚Äù.`]);
        }
      }
    }

    function tidySpaces(s){return s.replace(/\s+/g,' ').trim();}

    function correctSentence(raw){
      let original = tidySpaces(raw);
      if(!original) return { corrected:'', notes:[], diffHTML:'' };

      // tokenize by spaces, keep punctuation separately
      const tokens = original
        .replace(/([,.!?])/g,' $1 ')
        .replace(/\s+/g,' ')
        .split(' ')
        .filter(Boolean);

      const notes = [];

      fixIcap(tokens, notes);
      fixBeVerb(tokens, notes);
      fixHeSheVerb(tokens, notes);
      fixArticles(tokens, notes);
      fixAint(tokens, notes);
      pluralAfterNumber(tokens, notes);

      // join & cosmetic fixes
      let out = tokens.join(' ')
        .replace(/\s+([,.!?])/g,'$1'); // remove space before punctuation
      out = capitalizeSent(out);
      out = endWithPeriod(out);

      // build simple diff (mark words that changed)
      const diffHTML = highlightDiff(original, out);

      return { corrected: out, notes, diffHTML };
    }

    function highlightDiff(a,b){
      const A = tidySpaces(a).split(/\s+/), B = tidySpaces(b).split(/\s+/);
      let html = [], i=0, j=0;
      while(i<A.length || j<B.length){
        if(A[i]===B[j]){ html.push(B[j]); i++; j++; continue; }
        if(A[i] && !B.includes(A[i])){ html.push(`<mark class="bad">${A[i]}</mark>`); i++; continue; }
        if(B[j] && !A.includes(B[j])){ html.push(`<mark class="fix">${B[j]}</mark>`); j++; continue; }
        // fallback
        if(B[j]){ html.push(`<mark class="fix">${B[j]}</mark>`); j++; i++; }
        else i++;
      }
      let s = html.join(' ');
      return s.replace(/\s+([,.!?])/g,'$1');
    }

    /***************
     * UI Handlers
     ***************/
    const feedbackEl = document.getElementById('feedback');
    const correctedEl = document.getElementById('corrected');
    const evaluateBtn = document.getElementById('evaluateBtn');

    function evaluate(){
      const {corrected, notes, diffHTML} = correctSentence(input.value);
      correctedEl.innerHTML = corrected ? diffHTML : '';
      if(!corrected){ feedbackEl.innerHTML = '<span class="hint">Say or type a sentence to get feedback.</span>'; return; }

      if(notes.length===0){
        feedbackEl.innerHTML = `<span class="pill tag-ok">‚úî Looks good!</span>`;
      } else {
        feedbackEl.innerHTML = notes.map(([type,msg])=>`<span class="pill tag-bad">‚ùó ${msg}</span>`).join('');
      }
    }
    evaluateBtn.onclick = evaluate;

    /***************
     * PWA register
     ***************/
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
    }
  </script>
</body>
</html>
